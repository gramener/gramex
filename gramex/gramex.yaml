# This is the base configuration file for Gramex. To override it, copy the
# setting to your `gramex.yaml` and change it.

# Gramex APIs are versioned. The version key is required. Currently, 1.0 is the
# only version supported.
version: 1.0
# Define custom MIME types here
mime:
    .yml:       text/yaml
    .yaml:      text/yaml
    .md:        text/markdown
    .markdown:  text/markdown
    .json:      application/json
    .svg:       image/svg+xml
    .py:        text/plain
    .h5:        application/x-hdf5
    .hdf5:      application/x-hdf5

# Configure the thread pool that's shared across Gramex to run parallel threads.
threadpool:
    workers: 16                 # Max number of parallel threads

# Define system caches.
cache:
    memory:
        type: memory                    # A default in-memory cache

# Intiailise handlers
handlers:
    BaseHandler:
        log:
            format: csv
            path: $GRAMEXDATA/logs/requests.csv
            keys: [time, ip, user.id, status, duration, method, uri, error]
            # format: '%(status)d %(method)s %(uri)s (%(ip)s) %(duration).1fms %(user.id)s'

    FileHandler:
        ignore:
            - gramex.yaml               # Always ignore gramex.yaml in Filehandlers
            - ".*"                      # Hide dotfiles
            - "*.py*"                   # Hide Python scripts
        allow: '.allow'                 # Allow special dotfile

# The `log:` section defines the log handlers. It uses the same structure as the
# Python logging schema.
# https://docs.python.org/3/library/logging.config.html#logging-config-dictschema
log:
    version: 1
    root:
        level: DEBUG
        handlers:
            - console
            - access-log
    loggers:
        gramex: {}
        user:
            level: INFO
            propagate: false            # Do not propagate to root handler
            handlers:
                - user
        # Disable tornado loggers. Let them propagate to root
        tornado.access: {}
        tornado.application: {}
        tornado.general: {}
    handlers:
        none:
            class: logging.NullHandler
        console:
            class: logging.StreamHandler
            formatter: console
        text:
            class: logging.StreamHandler
            formatter: text
        access-log:
            class: logging.handlers.TimedRotatingFileHandler
            level: INFO
            formatter: file         # save it as a CSV file
            filename: $GRAMEXDATA/logs/access.csv    # file name to save as
            encoding: utf-8         # encoded as UTF-8
            when: W0                # rotate the log file weekly
            interval: 1             # every single week
            utc: False              # using local time zone, not UTC
            backupCount: 52         # keep only last 52 backups
            delay: true             # do not create file until called
        warn-log:
            class: logging.handlers.TimedRotatingFileHandler
            level: WARN
            formatter: file         # save it as a CSV file
            filename: $GRAMEXDATA/logs/warn.csv      # file name to save as
            encoding: utf-8         # encoded as UTF-8
            when: W0                # rotate the log file weekly
            interval: 1             # every single week
            utc: False              # using local time zone, not UTC
            backupCount: 52         # keep only last 52 backups
            delay: true             # do not create file until called
        user:
            class: logging.handlers.TimedRotatingFileHandler
            level: INFO
            formatter: csv-message  # Just save the time and message as-is
            filename: $GRAMEXDATA/logs/user.csv    # file name to save as
            encoding: utf-8         # encoded as UTF-8
            when: W0                # rotate the log file weekly
            interval: 1             # every single week
            utc: False              # using local time zone, not UTC
            backupCount: 52         # keep only last 52 backups
            delay: true             # do not create file until called
    formatters:
        text:
            format: '%(levelname)1.1s %(asctime)s %(module)s %(message)s'
            datefmt: '%d-%b %H:%M:%S'
        console:
            '()': colorlog.ColoredFormatter
            format: '%(log_color)s%(levelname)-8s%(reset)s%(asctime)s %(bold_yellow)s%(module)s%(reset)s %(message)s'
            datefmt: '%d-%b %H:%M:%S'
        file:
            format: '%(levelname)1.1s,%(asctime)s,%(module)s,%(lineno)d,"%(message)s"'
            datefmt: '%Y-%m-%d %H:%M:%S'
        csv-message:
            format: '%(asctime)s,%(message)s'
            datefmt: '%Y-%m-%d %H:%M:%S'
        message:
            format: '%(message)s'
            datefmt: '%Y-%m-%d %H:%M:%S'

# Application event logs are captured in this database. The logs are stored in a
# table called "events".
eventlog:
    path: $GRAMEXDATA/logs/events.db          # Location of application event logs.

# ------------------------------------------------------------------------------
# The app, schedule, url sections are defined at the end to allow these to use
# earlier services.

# The `app:` section defines the settings for the main Gramex application
app:
    browser: False                      # Open the browser on startup

    listen:
        port: 9988                      # Port to bind to. (8888 used by Jupyter)
        xheaders: True                  # X-Real-Ip/X-Forwarded-For and X-Scheme/X-Forwarded-Proto override remote IP, scheme
        max_buffer_size: 1000000000     # Max length of data that can be POSTed
        max_header_size: 1000000000     # Max length of header that can be received
        max_body_size: 1000000000       # Max length of data that can be uploaded

    # These are Tornado application settings. See
    # http://tornado.readthedocs.org/en/stable/web.html#tornado.web.Application.settings
    settings:                           # Tornado app settings
        # default_host: 'host'          # Optional name of default host
        compress_response: True         # GZip the HTTP response

        # Debug=true enables all the below parameters, as well as Ctrl+D for pdb debugging on console
        debug: False                    # autoreload + !compiled_template_cache + !static_hash_cache + serve_traceback
        # Debug parameters
        # autoreload: False               # Reload Gramex when imported Python file changes
        # compiled_template_cache: True   # Cache template files across requests
        # static_hash_cache: True         # Cache static files across requests
        # serve_traceback: True           # Show traceback on browser if there's an error

        # Cookie parameters
        xsrf_cookies: True              # Reject POST/PUT/DELETE unless _xsrf header / form input is present
        xsrf_cookie_kwargs:
            httponly: true              # Don't allow JavaScript access to cookies
            # secure: false               # Allow cookies only in HTTPS
        cookie_secret: secret-key       # Encrypt cookies with this secret key
        key_version: 2                  # Cookie encryption version. 2 is the latest

        # Template parameters
        autoescape: xhtml_escape        # Escape HTML tags in templates
        template_path: .                # Default location of templates (not currently used)
        static_path: './static'         # Local path for static files (not currently used)
        static_url_prefix: '/static/'   # URL prefix for static files (not currently used)

        # Login parameters
        login_url: /login/              # URL used to log in

    session:
        type: json      # Type of store to use: hdf5, json or memory
        flush: 5        # Write store to disk periodically (in seconds)
                        # For type:json, use 5 seconds. It does not save to disk automatically
                        # For type:hdf5, 60 seconds or so is fine
        path: $GRAMEXDATA/session.json  # Path to the store (ignored for memory)
        expiry: 31                      # Session cookies expiry in days


# The `schedule:` section defines when specific code is to run.
schedule:
    # Every day and on startup, check if Gramex needs to be updated
    gramex_update:
        function: gramex.gramex_update
        kwargs:
            url: https://gramener.com/gramex-update/
        startup: true
        minutes: 0
        hours: 0
        dates: '*'

# http://tornado.readthedocs.org/en/stable/web.html#tornado.web.URLSpec
# Define this section at the end, to allow it to use previous services.
url:
    default:                            # A unique name for this handler
        priority: -1                    # Apply this pattern with low than normal priority
        pattern: /(.*)                  # All URLs beginning with /
        handler: FileHandler                # Handler used
        kwargs:                             # Options to the handler
            path: .                         #   path is current dir
            default_filename: index.html    #   default filename
            index: true                     #   display the index
            headers:
                Cache-Control: max-age=60   # By default, cache for a minute
