<!doctype html>
<html lang="en">
{% set base = '.' %}
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>{{ handler.kwargs.mlhandler.get('title', "MLHandler") }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <style>
    .urlArea {
      font-family: monospace;
      font-size: 16px;
      border-style: solid;
      padding: 1%;
      border-radius: 10px;
      border-color: #a6aba7
    }
    .inline {
      display: inline-block;
    }
    img {
      width: 1em;
    }
  </style>

  <body>
    {% import gramex %}
    {% set cfg = gramex.conf.url[handler.kwargs.mlhandler.key] %}
    {% set data = gramex.data.filter(**cfg.kwargs.data)%}
    {% set model_kwargs = cfg.kwargs.model %}
    {% set columns = set(data.columns.tolist()) - set(model_kwargs.exclude) - {model_kwargs.target_col} %}

    <!-- TODO: Filter bars -->
    <div class="container-fluid py-4 px-3">
      <form id="predictform">
        {% set row = data[columns].iloc[0] %}
        {% for colname, value in row.items() %}
        <label for="{{ colname }}">{{ colname }}</label>
        <input type="text" name="{{ colname }}" value="{{ value }}"><br>
        {% end %}
        <input type="submit" value="Predict">
      </form>
      <h3>{{ model_kwargs.target_col }}:</h3>
      <p id="prediction">{{ data.iloc[0][model_kwargs.target_col] }}</p>

      <hr>
      <p>MLHandler is running at </p>
      <p class="urlArea">
        <a class="inline" id="handlerURL" target="_blank" href="{{ cfg.pattern }}">{{ cfg.pattern }}</a>
        <button class="inline">Copy</button>
      </p>
      <hr>
      <p>Usage in curl</p>
      <div class="urlArea">
        <p class="inline" id="curlcode"></p>
        <button class="inline">Copy</button>
      </div>
      <p>Usage in Python</p>
      <div class="urlArea">
        <p class="inline" id="pythoncode"></p>
        <button class="inline">Copy</button>
      </div>
    </div><!-- .container-fluid -->
  </body>

  <script src="https://cdn.jsdelivr.net/combine/npm/jquery,npm/lodash,npm/g1"></script>
  <script>
    let target_col = "{{ model_kwargs.target_col }}"
    function updatehref() {
      let feats = new URLSearchParams(new FormData(document.getElementById('predictform')))
      let url = new URL(window.location.origin + "{{ cfg.pattern }}")
      url.search = "?" + feats.toString()
      url = url.toString()
      document.querySelector('#handlerURL').setAttribute('href', url)
      document.querySelector('#handlerURL').innerText = url

      // Update curl and Python codes
      fetch('req?url=' + encodeURIComponent(url))
        .then((resp) => {if (resp.ok) {return resp.json()}})
        .then((urls) => {
          document.querySelector('#curlcode').innerText = urls.curl
          document.querySelector('#curlcode').setAttribute('href', urls.curl)
          document.querySelector('#pythoncode').innerText = urls.python
          document.querySelector('#pythoncode').setAttribute('href', urls.python)
        })
      return url
    }
    window.onload = updatehref
    document.querySelector('#predictform')
      .addEventListener('submit', function(evt) {
        evt.preventDefault()
        url = updatehref()
        fetch(url)
          .then((resp) => {
            if (resp.ok) { return resp.json() }
          }).then((pred) => {
            document.querySelector('#prediction').innerText = pred[0][target_col]
          })
      })
    document.querySelectorAll('button.inline').forEach(el => {
      el.addEventListener('click', function(evt) {
        let text = evt.target.previousElementSibling.getAttribute('href')
        navigator.clipboard.writeText(text)
      })
    })
  </script>

</html>
