<ul class="nav nav-tabs" id="myTab" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="predictTab" data-toggle="tab" href="#predict" role="tab" aria-controls="predict" aria-selected="true">Predict</a>
  </li>
  <li class="nav-item">
    <a class="nav-link disabled" id="annotateTab" data-toggle="tab" href="#annotate" role="tab" aria-controls="annotate" aria-selected="false" aria-disabled="true">Annotate</a>
  </li>
</ul>
<div class="tab-content" id="myTabContent">
  <div class="tab-pane fade show active" id="predict" role="tabpanel" aria-labelledby="predictTab">
    <div class="container pt-3">
      <div class="row">
        <div class="col-9">
          <textarea class="form-control" id="inputText" rows="5" placeholder="Type text or drop a JSON file here.">
          </textarea>
        </div>
        <div class="col-3">
          <div class="row">
            <button class="col-sm btn btn-primary stdbtn" id="predbtn" type="button">Predict</button>
          </div>
          <div class="row pt-3">
            <a class="col-sm btn btn-primary stdbtn" id="downloadbtn">Download</a>
          </div>
        </div>
      </div>
      <div class="row pt-2">
        <div class="col formhandler"></div>
      </div>
    </div>
  </div>
  <div class="tab-pane fade" id="annotate" role="tabpanel" aria-labelledby="annotateTab">
    <div class="container pt-3">
      <div class="row"><h3>You have annotated <span id="n_ann">0</span> documents</h3></div>
      <div class="row">
        <div id="labelstudio"></div>
      </div>
      <div class="row">
        <div class="col">
          <button class="btn btn-primary" id="trainAnn" disabled>Train</button>
        </div>
        <div class="col"><h3 id='scoretext'></h3></div>
      </div>
    </div>
  </div>
</div>
<script>
  var currentResults = []
  var currentAnnotations = []
  var currentAnnIx = 0
  function disableControls() {
    $('textarea').prop('disabled', true)
    $('.stdbtn').prop('disabled', true)
    $('#predbtn').html('<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>')

  }
  function enableControls() {
    $('textarea').prop('disabled', false)
    $('.stdbtn').prop('disabled', false)
    $('#predbtn').html("Predict")
  }
  var LS_CONFIG = {
    config: `
        <View>
          <Header value="Select sentiment:"/>
          <Text name="my_text" value="$text"/>
          <Choices name="sentiment" toName="my_text" choice="single" showInline="true">
          {% for label in handler.model.model.labels %}
            <Choice value="{{ label }}"/>
          {% end %}
          </Choices>
        </View>
        `,
    interfaces: ['basic', 'panel', 'update', 'controls'],
    onUpdateAnnotation: function(ls, completion) {
      currentAnnotations.push({
        text: currentResults[currentAnnIx].text,
        label: completion.serializeAnnotation()[0].value.choices[0]
      })
      $('#trainAnn').prop('disabled', false)
      currentAnnIx += 1
      $('#n_ann').text(`${currentAnnIx}`)
      if (currentAnnIx < currentResults.length) {
        renderLabelStudio(currentResults[currentAnnIx])
      }
    }
  }
  function renderLabelStudio(data) {
    LS_CONFIG.task = {
      completions: [{
        result: [{
          type: "choices",
          from_name: "sentiment",
          to_name: "my_text",
          value: {choices: [data.label]}
        }]
      }],
      data: {text: data.text}
    }
    var labelStudio = new LabelStudio('labelstudio', LS_CONFIG)
  }
  function enableAnnotations() {
    $('#annotateTab').removeClass('disabled')
    $('#annotateTab').prop('aria-disabled', false)
    renderLabelStudio(currentResults[currentAnnIx])
  }
  function renderPredictions() {
    enableAnnotations()
    $('.formhandler').formhandler({
      data: currentResults,
      export: false,
      pageSize: 20,
      columns: [{name: "text", link: false}, {name: "label"}]
    })
  }
  function enableDownloads() {
    $('#downloadbtn').attr('href',
      'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(currentResults)))
    $('#downloadbtn').attr('download', 'predictions.json')
    $('#downloadbtn').attr('_target', '_blank')
  }



  $(document).ready(function() {

    $('#trainAnn').click(function() {
      $('#trainAnn').prop('disabled', true)
      $('#trainAnn').html('<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>')
      $.ajax({
        url: window.location.pathname + '?_action=train&target_col=label',
        method: 'POST',
        data: JSON.stringify(currentAnnotations),
        contentType: 'application/json',
        processData: false,
        success: function(resp) {
          $('#trainAnn').prop('disabled', false)
          $('#trainAnn').html('Train')
          $('#scoretext').text(`ROC AUC Score: ${resp.score}`)
        }
      })
    })

    $('#predbtn').click(function() {
      disableControls()
      fetch(window.location.pathname + '?text=' + encodeURIComponent($('textarea').val()))
        .then(resp => resp.json())
        .then(function(data) {
          currentResults = data
          renderPredictions()
          enableControls()
          enableDownloads()
      })
    })

    // Attach dropzone
    $('#inputText').dropzone({
      url: window.location.pathname + '?_action=predict',
      clickable: false,
      createImageThumbnails: false,
      previewTemplate: '<div></div>',
      acceptedFiles: 'application/json',
      init: function() {
        this.on('success', function(fileObj) {
          enableControls()
          currentResults = JSON.parse(fileObj.xhr.responseText)
          renderPredictions()
          enableDownloads()
        })
        this.on('sending', function(fileObj) {
          disableControls()
        })
        this.on('error', function(fileObj) {
          enableControls()
        })
      }
    })
  })
</script>
